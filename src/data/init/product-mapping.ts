/**
 * 产品初始化映射配置
 * 根据图片URL中的文件名匹配产品信息
 */

export interface ProductMapping {
  /** 关键词（从文件名提取） */
  keywords: string[];
  /** 产品名称 */
  name: string;
  /** 所属分类ID */
  categoryIds: string[];
  /** 简短描述 */
  description: string;
  /** 详细介绍（Markdown格式） */
  content: string;
}

export const productMappings: ProductMapping[] = [
  {
    keywords: ["活性炭"],
    name: "活性炭滤料",
    categoryIds: ["filter-media"],
    description: "优质活性炭滤料，高效吸附，强力去除水中的有机物、余氯、异味等杂质",
    content: `## 产品介绍

活性炭是一种经过特殊处理的炭，具有丰富的微孔结构和巨大的比表面积，吸附能力极强。广泛应用于水处理领域的深度净化。

## 产品特点

- **吸附力强**：巨大的比表面积，吸附容量大
- **孔隙发达**：丰富的微孔结构，吸附速度快
- **再生容易**：可反复再生使用，经济环保
- **化学稳定性好**：耐酸碱，适用范围广

## 技术参数

- **碘值**：≥900mg/g
- **亚甲蓝值**：≥150mg/g
- **强度**：≥90%
- **粒度**：可根据需求定制

## 应用领域

- 饮用水深度处理
- 工业废水处理
- 游泳池水处理
- 中水回用
- 除臭、脱色

## 包装规格

25kg/袋，或根据客户要求定制`
  },
  {
    keywords: ["聚丙烯酰胺", "PAM"],
    name: "聚丙烯酰胺（PAM）",
    categoryIds: ["agents"],
    description: "高分子絮凝剂，高效絮凝沉淀，广泛应用于污水处理、污泥脱水等领域",
    content: `## 产品介绍

聚丙烯酰胺（Polyacrylamide，简称PAM）是一种水溶性高分子聚合物，具有良好的絮凝性、增稠性、剪切性、降阻性等性能，被誉为"百业助剂"。

## 产品特点

- **絮凝效果好**：形成的絮体大、沉降快
- **用量少**：处理效率高，成本低
- **适用范围广**：适应多种水质条件
- **环保安全**：无毒无害，符合环保标准

## 产品型号

- **阴离子型（APAM）**：用于无机废水处理
- **阳离子型（CPAM）**：用于污泥脱水、有机废水处理
- **非离子型（NPAM）**：用于特殊酸性条件

## 技术参数

- **分子量**：300-2200万
- **固含量**：≥90%
- **溶解时间**：≤60分钟
- **有效pH值**：4-11

## 应用领域

- 城市污水处理
- 工业废水处理
- 污泥脱水
- 造纸废水
- 选矿废水
- 纺织印染废水

## 使用方法

1. 配制成0.1-0.3%的水溶液
2. 充分搅拌溶解
3. 按照实验确定的最佳投加量投加
4. 建议现场小试确定最佳投加量

## 包装储存

- 包装：25kg/袋
- 储存：阴凉干燥处，防潮防湿
- 保质期：2年`
  },
  {
    keywords: ["聚合氯化铝", "PAC"],
    name: "聚合氯化铝（PAC）",
    categoryIds: ["agents"],
    description: "高效无机高分子絮凝剂，絮凝沉淀效果好，广泛应用于饮用水、工业废水处理",
    content: `## 产品介绍

聚合氯化铝（Polyaluminium Chloride，简称PAC）是一种无机高分子絮凝剂，介于三氯化铝和氢氧化铝之间的产物，通过羟基而架桥聚合，分子式为[Al2(OH)nCl6-n]m。

## 产品特点

- **絮凝体形成快**：沉降速度快，活性高
- **用量少**：成本低，处理效果好
- **适用pH范围广**：pH值5-9均可使用
- **腐蚀性小**：对设备腐蚀小，操作方便
- **净水效果优良**：浊度、色度去除率高

## 产品指标

- **氧化铝含量**：28-32%
- **盐基度**：40-90%
- **水不溶物**：≤1.5%
- **砷含量**：≤0.0005%

## 应用领域

### 饮用水处理
- 自来水厂净化
- 乡镇供水处理
- 地下水除铁除锰

### 工业废水处理
- 造纸废水白水回收
- 印染废水脱色
- 皮革废水处理
- 电镀废水处理
- 煤矿废水处理

### 市政污水
- 城市污水处理
- 生活污水处理

## 使用方法

1. 根据原水水质，通过实验确定最佳投加量
2. 配制成10-20%的水溶液
3. 投加点选择在混合池或反应池前端
4. 控制搅拌速度，利于絮体成长

## 包装储存

- 包装：25kg/袋（内塑料袋，外编织袋）
- 储存：阴凉干燥处，防潮防湿
- 保质期：2年

## 注意事项

- 不同水质需要调整投加量和pH值
- 建议现场小试确定最佳工艺参数
- 使用时注意个人防护`
  },
  {
    keywords: ["硫酸铝"],
    name: "硫酸铝",
    categoryIds: ["agents"],
    description: "传统絮凝剂，絮凝效果好，成本低，适用于城市给水、污水处理及造纸工业",
    content: `## 产品介绍

硫酸铝（Aluminium Sulfate），化学式Al2(SO4)3，是一种广泛应用于水处理和造纸工业的无机絮凝剂。外观为白色结晶粉末，易溶于水。

## 产品特点

- **絮凝效果好**：形成絮体大，沉降速度快
- **价格低廉**：处理成本低
- **使用简便**：操作方便，易于控制
- **稳定性好**：不易分解，便于储存

## 产品指标

- **氧化铝含量**：≥15.5%
- **铁含量**：≤0.5%
- **水不溶物**：≤0.15%
- **游离硫酸**：≤2.0%

## 应用领域

### 给水处理
- 城市自来水净化
- 乡镇供水处理
- 工业给水处理

### 污水处理
- 城市污水处理
- 工业废水处理
- 生活污水处理

### 其他应用
- 造纸施胶剂
- 皮革鞣剂
- 消防灭火剂
- 媒染剂

## 使用方法

1. **溶解**：将硫酸铝配制成10-20%的水溶液
2. **投加**：按照100-500mg/L的投加量投加
3. **搅拌**：快速搅拌1-2分钟，慢速搅拌10-15分钟
4. **沉淀**：静置沉淀，上清液排放或回用

## 包装储存

- 包装：25kg/袋，50kg/袋
- 储存：通风干燥处，防潮防湿
- 保质期：2年

## 注意事项

- 投加量需根据水质调整
- 溶液应现配现用
- 注意控制pH值（最佳pH范围6.5-7.5）
- 使用时佩戴防护用品`
  }
];

/**
 * 从图片URL中提取产品名称并匹配映射配置
 */
export function matchProductByUrl(url: string): ProductMapping | null {
  try {
    // 提取文件名（解码URL）
    const urlObj = new URL(url);
    const pathname = decodeURIComponent(urlObj.pathname);

    // 提取文件名（不含扩展名和数字后缀）
    const filename = pathname
      .split('/')
      .pop()
      ?.replace(/\.\w+(\?.*)?$/, '') // 移除扩展名和查询参数
      .replace(/\d+$/, '') // 移除末尾数字
      .toLowerCase() || '';

    // 匹配产品
    return (
      productMappings.find((mapping) =>
        mapping.keywords.some((keyword) =>
          filename.includes(keyword.toLowerCase())
        )
      ) || null
    );
  } catch (error) {
    console.error('Failed to parse URL:', url, error);
    return null;
  }
}

/**
 * 清理图片URL，保留必要的签名参数
 * 注意：腾讯云COS私有文件需要签名才能访问
 */
export function cleanImageUrl(url: string): string {
  try {
    const urlObj = new URL(url);
    // 保留所有查询参数（包含签名）
    // 只移除可能导致问题的参数
    const paramsToRemove = ['ci-process']; // 移除图片处理参数
    paramsToRemove.forEach(param => {
      urlObj.searchParams.delete(param);
    });
    return urlObj.toString();
  } catch {
    return url;
  }
}
